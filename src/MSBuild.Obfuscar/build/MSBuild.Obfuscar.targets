<?xml version="1.0" encoding="utf-8"?>
<!--
***********************************************************************************************
MSBuild.Obfuscator.targets

WARNING:  DO NOT MODIFY this file unless you are knowledgeable about MSBuild and have
          created a backup copy.  Incorrect changes to this file will make it
          impossible to load or build your projects from the command-line or the IDE.

***********************************************************************************************
-->
<Project ToolsVersion="4.0" DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <UsingTask TaskName="MSBuild.Obfuscar.Tasks.Obfuscate" AssemblyFile="$(MSBuildThisFileDirectory)..\tools\MSBuild.Obfuscar.Tasks.dll" />
  
  <PropertyGroup>
    
    <ObfuscatorToolsVersion>2.2.31</ObfuscatorToolsVersion>

    <!-- ObfuscatorToolsPath -->
    <ObfuscatorToolsPath Condition="'$(NuGetProjectStyle)' == 'PackageReference'">$(MSBuildThisFileDirectory)..\..\..\obfuscar\$(ObfuscatorToolsVersion)\tools</ObfuscatorToolsPath>
    <ObfuscatorToolsPath Condition="'$(NuGetProjectStyle)' == 'PackageReference' And !Exists('$(ObfuscatorToolsPath)')">$(NuGetPackageRoot)obfuscar\$(ObfuscatorToolsVersion)\tools</ObfuscatorToolsPath>

    <ObfuscatorToolsPath Condition="'$(NuGetProjectStyle)' != 'PackageReference'">$(MSBuildThisFileDirectory)..\..\obfuscar.$(ObfuscatorToolsVersion)\tools</ObfuscatorToolsPath>
    <ObfuscatorToolsPath Condition="'$(NuGetProjectStyle)' != 'PackageReference' And !Exists('$(ObfuscatorToolsPath)')">$(SolutionDir)packages\obfuscar.$(ObfuscatorToolsVersion)\tools</ObfuscatorToolsPath>

  </PropertyGroup>

  <PropertyGroup>

    <!-- Obfuscator command -->
    <ObfuscatorExePath Condition=" '$(ObfuscatorExePath)' == '' ">$(ObfuscatorToolsPath)\Obfuscar.Console.exe</ObfuscatorExePath>

    <ObfuscatorCommand Condition=" '$(OS)' == 'Windows_NT'">"$(ObfuscatorExePath)"</ObfuscatorCommand>
    <ObfuscatorCommand Condition=" '$(OS)' != 'Windows_NT' ">mono "$(ObfuscatorExePath)"</ObfuscatorCommand>

    <!-- PaddedSolutionDir -->
    <PaddedSolutionDir Condition=" '$(OS)' == 'Windows_NT'">"$(SolutionDir) "</PaddedSolutionDir>
    <PaddedSolutionDir Condition=" '$(OS)' != 'Windows_NT' ">"$(SolutionDir)"</PaddedSolutionDir>

    <!-- ObfuscatorConfigTemplate -->
    <ObfuscatorConfigTemplate Condition=" '$(OS)' == 'Windows_NT' AND !Exists('$(ObfuscatorConfigTemplate)')">$([System.IO.Path]::Combine($(ProjectDir), "$(ProjectName).xml"))</ObfuscatorConfigTemplate>
    <ObfuscatorConfigTemplate Condition=" '$(OS)' == 'Windows_NT' AND !Exists('$(ObfuscatorConfigTemplate)')">$([System.IO.Path]::Combine($(ProjectDir), "Obfuscar.xml"))</ObfuscatorConfigTemplate>
    <ObfuscatorConfigTemplate Condition=" '$(OS)' == 'Windows_NT' AND !Exists('$(ObfuscatorConfigTemplate)')">$([System.IO.Path]::Combine($(SolutionDir), "Obfuscar.xml"))</ObfuscatorConfigTemplate>

    <ObfuscatorConfigTemplate Condition=" '$(OS)' != 'Windows_NT' AND !Exists('$(ObfuscatorConfigTemplate)')">$(ProjectDir)$(ProjectName).xml</ObfuscatorConfigTemplate>
    <ObfuscatorConfigTemplate Condition=" '$(OS)' != 'Windows_NT' AND !Exists('$(ObfuscatorConfigTemplate)')">$(ProjectDir)Obfuscar.xml</ObfuscatorConfigTemplate>
    <ObfuscatorConfigTemplate Condition=" '$(OS)' != 'Windows_NT' AND !Exists('$(ObfuscatorConfigTemplate)')">$(SolutionDir)Obfuscar.xml</ObfuscatorConfigTemplate>

    <!-- Commands -->
    <ObfuscateCommand>$(ObfuscatorCommand) "$(ObfuscatorConfigTemplate)"</ObfuscateCommand>
  </PropertyGroup>

  <Target Name="CheckPrerequisites">
    <!-- Raise an error if we're unable to locate Obfuscator.cli.exe  -->
    <Error Condition="'$(DownloadObfuscatorExe)' != 'true' AND !Exists('$(ObfuscatorExePath)')" Text="Unable to locate '$(ObfuscatorExePath)'" />
  </Target>

  <Target Name="Obfuscator" AfterTargets="AfterBuild" DependsOnTargets="CheckPrerequisites" Condition="'$(ConfigurationName)' == 'Release'">

    <Obfuscate 
      Obfuscator="$(ObfuscatorExePath)" 
      ObfuscatorConfigTemplate="$(ObfuscatorConfigTemplate)" 
      
      ProjectDir="$(ProjectDir)" 
      ProjectName="$(ProjectName)"
      TargetDir="$(TargetDir)" 
      TargetFileName="$(TargetFileName)"  />
  <!--
    
    <MakeDir Directories="$(TargetDir)obfuscated" />
    <Exec WorkingDirectory="$(ProjectDir)" Command="$(ObfuscateCommand)" />
    <ItemGroup>
      <FilesToMove Include="$(TargetDir)obfuscated\*.*" />
    </ItemGroup>
    <Move SourceFiles="@(FilesToMove)" DestinationFolder="$(TargetDir)" OverwriteReadOnlyFiles="true" Condition=" '$(OS)' == 'Windows_NT'" />
    <RemoveDir Directories="$(TargetDir)obfuscated" Condition=" '$(OS)' == 'Windows_NT'" />
    -->
  </Target>
</Project>